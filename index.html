<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hvor skal jeg reise? üó∫Ô∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 350px; border-radius: 24px; border: 2px solid #e2e8f0; z-index: 1; }
        .active-cat { background-color: white !important; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); color: #1e40af !important; border: 1px solid #e2e8f0; }
        .warning-pill { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
    </style>
</head>
<body class="bg-slate-50 font-sans min-h-screen pb-20">

    <div class="max-w-6xl mx-auto p-4 md:p-8">
        <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-4xl font-black text-blue-900 tracking-tight">Hvor skal jeg reise?</h1>
                <p class="text-slate-500 font-medium">Reiseanbefalinger basert p√• v√¶r og tid</p>
            </div>
            <div class="bg-blue-600 text-white px-6 py-3 rounded-2xl shadow-lg border-b-4 border-blue-800">
                <span class="text-[10px] uppercase font-black opacity-80 block">Valgt avreisetid:</span>
                <span id="header-time" class="text-sm font-bold tracking-tight">Laster tid...</span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-[32px] shadow-sm border border-slate-200">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-3">
                        <span class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm shadow-md">1</span>
                        Mitt startpunkt
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <button onclick="finnMinPosisjon()" class="p-4 bg-blue-100 text-blue-600 rounded-2xl hover:bg-blue-200 transition-all shadow-sm" title="Bruk min posisjon">üìç</button>
                        <input type="text" id="adresseSok" placeholder="Hvor reiser du fra?" class="flex-1 px-5 py-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-blue-400 transition-all">
                        <button onclick="sokAdresse()" class="px-8 py-4 bg-slate-900 text-white rounded-2xl text-sm font-bold hover:bg-black transition-all">S√∏k</button>
                    </div>
                    <div id="map"></div>
                </div>

                <div class="bg-white p-6 rounded-[32px] shadow-sm border border-slate-200">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-3">
                        <span class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm shadow-md">2</span>
                        Hva vil du gj√∏re?
                    </h2>
                    <div class="flex flex-wrap gap-2 mb-4 p-1.5 bg-slate-100 rounded-[22px]">
                        <button onclick="setKategori('sn√∏')" id="cat-sn√∏" class="flex-1 py-3 rounded-[18px] font-bold text-xs transition-all">‚ùÑÔ∏è Sn√∏</button>
                        <button onclick="setKategori('tur')" id="cat-tur" class="flex-1 py-3 rounded-[18px] font-bold text-xs transition-all">ü•æ Tur</button>
                        <button onclick="setKategori('sykkel')" id="cat-sykkel" class="flex-1 py-3 rounded-[18px] font-bold text-xs transition-all">üö≤ Sykkel</button>
                        <button onclick="setKategori('vind')" id="cat-vind" class="flex-1 py-3 rounded-[18px] font-bold text-xs transition-all">üí® Vind</button>
                    </div>
                    <div id="sub-menu" class="grid grid-cols-2 gap-3"></div>
                </div>

                <div class="bg-white p-6 rounded-[32px] shadow-sm border border-slate-200">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-3">
                        <span class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm shadow-md">3</span>
                        N√•r skal du reise?
                    </h2>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <button onclick="settHurtigTid(0)" class="py-4 bg-slate-100 rounded-2xl text-[10px] font-black uppercase hover:bg-slate-200 transition-all">N√•</button>
                        <button onclick="settHurtigTid(30)" class="py-4 bg-slate-100 rounded-2xl text-[10px] font-black uppercase hover:bg-slate-200 transition-all">+30 min</button>
                        <button onclick="justerTid(60)" class="py-4 bg-blue-50 text-blue-700 border border-blue-100 rounded-2xl text-[10px] font-black uppercase hover:bg-blue-100 transition-all">+1 time</button>
                    </div>
                    <input type="datetime-local" id="customTime" onchange="settEgendefinertTid()" class="w-full bg-slate-50 p-4 rounded-2xl text-sm font-bold text-slate-700 border border-slate-200 outline-none focus:border-blue-400">
                </div>
            </div>

            <div class="space-y-4">
                <div id="results-header" class="flex justify-between items-center px-4">
                    <h2 class="text-sm font-black text-slate-400 uppercase tracking-[0.2em]">Anbefalte destinasjoner</h2>
                    <div class="h-1 flex-1 mx-4 bg-slate-100 rounded-full"></div>
                </div>
                <div id="results" class="grid grid-cols-1 gap-4"></div>
            </div>
        </div>
    </div>

    <script>
        let startPos = { lat: 59.949, lon: 10.817 };
        let hovedKategori = 'sn√∏';
        let underKategori = 'langrenn';
        let avreiseTid = new Date();
        let alleSteder = [];
        let marker;

        const subValg = {
            'sn√∏': [{ id: 'langrenn', navn: 'üéø Langrenn' }, { id: 'alpint', navn: 'üèÇ Alpint' }],
            'tur': [{ id: 'kyst', navn: 'üåä Kyst' }, { id: 'skog', navn: 'üå≤ Skog' }, { id: 'stier', navn: 'ü•æ Stier' }, { id: 'topper', navn: '‚õ∞Ô∏è Topper' }],
            'sykkel': [{ id: 'landevei', navn: 'üö¥ Landevei' }, { id: 'terreng', navn: 'üöµ Terreng' }],
            'vind': [{ id: 'hav', navn: 'üåä Hav' }, { id: 'innsj√∏', navn: 'üõ∂ Innsj√∏' }]
        };

        const map = L.map('map', { tap: false }).setView([startPos.lat, startPos.lon], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        marker = L.marker([startPos.lat, startPos.lon], { draggable: true }).addTo(map);
        
        marker.on('dragend', () => {
            startPos = { lat: marker.getLatLng().lat, lon: marker.getLatLng().lng };
            oppdaterOversikt();
        });

        function finnN√¶rmesteV√¶r(timeseries) {
            const target = avreiseTid.getTime();
            return timeseries.reduce((prev, curr) => {
                const prevDiff = Math.abs(new Date(prev.time).getTime() - target);
                const currDiff = Math.abs(new Date(curr.time).getTime() - target);
                return currDiff < prevDiff ? prev : prev;
            });
        }

        function lagAdvarsler(s, t, eff) {
            let html = "";
            const k = hovedKategori;
            const u = underKategori;

            const r√∏dStil = "bg-red-600 text-white font-black px-4 py-2 rounded-xl text-[10px] mb-1.5 flex items-center gap-2 warning-pill shadow-md";
            const gulStil = "bg-amber-100 text-amber-900 font-bold px-4 py-2 rounded-xl text-[10px] mb-1.5 border border-amber-200 flex items-center gap-2";
            const svartStil = "bg-slate-900 text-white font-black px-4 py-2 rounded-xl text-[10px] mb-1.5 flex items-center gap-2 shadow-lg";

            // SN√ò
            if (k === 'sn√∏' && eff <= -25) {
                html += `<div class="${r√∏dStil}">‚ö†Ô∏è Advarsel om forfrysning!</div>`;
            }

            // SYKKEL
            if (k === 'sykkel') {
                if (eff < 0) html += `<div class="${gulStil}">‚ö†Ô∏è Advarsel om is og sne p√• veien, b√∏r ha piggdekk og kle seg ekstra godt</div>`;
                if (eff <= -15) html += `<div class="${r√∏dStil}">‚ö†Ô∏è Advarsel om fare for forfrysning!</div>`;
            }

            // VIND
            if (k === 'vind') {
                if (t <= 0) html += `<div class="${gulStil}">‚ö†Ô∏è Advarsel: Farlig pga kulde og isforhold</div>`;
                if (eff <= -15) html += `<div class="${r√∏dStil}">‚ö†Ô∏è Advarsel om fare for forfrysning</div>`;
            }

            // TUR
            if (k === 'tur') {
                if (t <= 0) html += `<div class="${gulStil}">‚ö†Ô∏è Advarsel om glatt f√∏re pgs sn√∏ og is</div>`;
                if (eff <= -15 && eff > -25) html += `<div class="${r√∏dStil}">‚ö†Ô∏è Advarsel om forfrysning</div>`;
                if (eff <= -25) html += `<div class="${r√∏dStil} ring-4 ring-red-200">‚ö†Ô∏è Advarsel om alvorlig forfrysning</div>`;
                if (u === 'topper' && t < 0) {
                    html += `<div class="${svartStil}">üö´ Om du ikke er en profesjonell klatrer, hold deg hjemme!</div>`;
                }
            }

            return html;
        }

        async function oppdaterOversikt() {
            const resDiv = document.getElementById('results');
            resDiv.innerHTML = '<div class="p-20 text-center"><div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-600 border-t-transparent"></div><p class="mt-4 text-slate-400 font-bold">Beregner beste reisem√•l...</p></div>';
            
            let resultater = [];
            let steder = alleSteder.filter(s => s.hovedkategori === hovedKategori && s.underkategori === underKategori);

            for (const sted of steder) {
                try {
                    const res = await fetch(`https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${sted.lat}&lon=${sted.lon}`);
                    const data = await res.json();
                    const varsel = finnN√¶rmesteV√¶r(data.properties.timeseries);
                    
                    const t = varsel.data.instant.details.air_temperature;
                    const v = varsel.data.instant.details.wind_speed;
                    const eff = Math.round(13.12 + 0.6215*t - 11.37*Math.pow(v*3.6, 0.16) + 0.3965*t*Math.pow(v*3.6, 0.16));
                    const symbol = varsel.data.next_1_hours ? varsel.data.next_1_hours.summary.symbol_code : varsel.data.next_6_hours.summary.symbol_code;

                    // N√∏yaktig avstandssortering
                    const d = Math.sqrt(Math.pow(sted.lat - startPos.lat, 2) + Math.pow(sted.lon - startPos.lon, 2)) * 111;
                    const tidMin = Math.round(d * 1.6 + 10);

                    resultater.push({ ...sted, t, v, eff, symbol, tidMin, avstand: d });
                } catch (e) { console.error(e); }
            }

            // SORTERING: Kortest reisevei f√∏rst
            resultater.sort((a, b) => a.avstand - b.avstand);

            resDiv.innerHTML = resultater.map(s => `
                <div class="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm hover:shadow-xl hover:border-blue-100 transition-all group">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] font-black text-blue-600 uppercase tracking-widest">${s.fylke}</span>
                                <span class="text-slate-200">‚Ä¢</span>
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">üöó CA ${s.tidMin} MIN</span>
                            </div>
                            <h3 class="text-2xl font-bold text-slate-900 mb-4 group-hover:text-blue-900 transition-colors">${s.navn}</h3>
                            
                            <div class="flex gap-3 mb-5">
                                <div class="bg-slate-50 px-4 py-2 rounded-2xl border border-slate-100 min-w-[70px]">
                                    <span class="block text-[9px] font-black text-slate-400 uppercase mb-0.5">Temp</span>
                                    <span class="text-lg font-black text-slate-800">${Math.round(s.t)}¬∞</span>
                                </div>
                                <div class="bg-blue-50 px-4 py-2 rounded-2xl border border-blue-100 min-w-[70px]">
                                    <span class="block text-[9px] font-black text-blue-400 uppercase mb-0.5">F√∏les</span>
                                    <span class="text-lg font-black text-blue-800">${s.eff}¬∞</span>
                                </div>
                                <div class="bg-slate-50 px-4 py-2 rounded-2xl border border-slate-100 min-w-[70px]">
                                    <span class="block text-[9px] font-black text-slate-400 uppercase mb-0.5">Vind</span>
                                    <span class="text-lg font-black text-slate-800">${Math.round(s.v)}</span>
                                </div>
                            </div>
                            
                            <div class="flex flex-col items-start">
                                ${lagAdvarsler(s, s.t, s.eff)}
                            </div>
                        </div>
                        <div class="text-right">
                            <img src="https://raw.githubusercontent.com/metno/weathericons/main/weather/png/${s.symbol}.png" class="w-20 h-20 drop-shadow-md group-hover:scale-110 transition-transform">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- Kontroll-logikk ---
        function settHurtigTid(m) {
            avreiseTid = m === 0 ? new Date() : new Date(new Date().getTime() + m * 60000);
            oppdaterTid();
        }
        function justerTid(m) {
            avreiseTid = new Date(avreiseTid.getTime() + m * 60000);
            oppdaterTid();
        }
        function settEgendefinertTid() {
            avreiseTid = new Date(document.getElementById('customTime').value);
            oppdaterTid();
        }
        function oppdaterTid() {
            const formatert = avreiseTid.toLocaleString('no-NO', { weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
            document.getElementById('header-time').innerText = formatert;
            document.getElementById('customTime').value = new Date(avreiseTid.getTime() - avreiseTid.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            oppdaterOversikt();
        }

        function setKategori(k) {
            hovedKategori = k;
            underKategori = subValg[k][0].id;
            document.querySelectorAll('[id^="cat-"]').forEach(btn => btn.classList.remove('active-cat'));
            document.getElementById('cat-'+k).classList.add('active-cat');
            oppdaterSubMenu();
            oppdaterOversikt();
        }

        function oppdaterSubMenu() {
            document.getElementById('sub-menu').innerHTML = subValg[hovedKategori].map(item => `
                <button onclick="underKategori='${item.id}'; oppdaterSubMenu(); oppdaterOversikt();" 
                        class="py-3 px-4 rounded-2xl font-black text-[10px] uppercase tracking-wider border-2 transition-all 
                        ${underKategori === item.id ? 'border-blue-600 bg-blue-600 text-white shadow-md' : 'border-slate-100 bg-white text-slate-400 hover:border-slate-300'}">
                    ${item.navn}
                </button>
            `).join('');
        }

        function finnMinPosisjon() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => {
                    startPos = { lat: p.coords.latitude, lon: p.coords.longitude };
                    marker.setLatLng([startPos.lat, startPos.lon]);
                    map.setView([startPos.lat, startPos.lon], 13);
                    oppdaterOversikt();
                }, () => alert("Kunne ikke hente posisjon. Sjekk personvernvalg."));
            }
        }

        function sokAdresse() {
            const q = document.getElementById('adresseSok').value;
            if (q.length < 2) return;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`).then(r => r.json()).then(data => {
                if (data[0]) {
                    startPos = { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                    marker.setLatLng([startPos.lat, startPos.lon]);
                    map.setView([startPos.lat, startPos.lon], 13);
                    oppdaterOversikt();
                }
            });
        }

        // Start
        fetch('locations.json').then(r => r.json()).then(data => {
            alleSteder = data;
            oppdaterTid();
            setKategori('sn√∏');
        }).catch(err => {
            console.error("Klarte ikke laste locations.json. S√∏rg for at filen ligger i samme mappe.");
        });
    </script>
</body>
</html>