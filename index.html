<!DOCTYPE html>
<html lang="no">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Hvor skal jeg reise?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { background-color: #f8faff; font-family: sans-serif; }
        .card { background: white; border-radius: 40px; padding: 2.5rem; border: 1px solid #edf2f7; margin-bottom: 2rem; }
        #map { height: 350px; border-radius: 20px; border: 1px solid #e2e8f0; margin-top: 1.5rem; }
        .cat-pill { padding: 1.25rem 1.75rem; border-radius: 25px; font-weight: 800; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.75rem; transition: all 0.2s; }
        .cat-pill.active { background: white; color: #1e40af; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        .cat-pill:not(.active) { color: #64748b; }
        .sub-btn { padding: 1.2rem; border-radius: 25px; font-weight: 800; text-transform: uppercase; font-size: 0.75rem; border: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: center; gap: 0.6rem; }
        .sub-btn.active { background: #3b82f6; color: white; box-shadow: 0 8px 15px rgba(59, 130, 246, 0.3); }
        .time-btn { background: #f1f5f9; padding: 1rem; border-radius: 20px; font-weight: 900; font-size: 0.65rem; text-transform: uppercase; color: #0f172a; transition: all .2s; }
        .time-btn:hover { background: #e2e8f0; }
        .time-btn-blue { background: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; }
        .warning-tag { display: flex; align-items: center; gap: .5rem; padding: .6rem 1rem; border-radius: 12px; font-size: .75rem; font-weight: 800; margin-top: .4rem; }
        .w-red { background: #dc2626; color: white; }
        .w-yellow { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .w-black { background: #0f172a; color: white; }
        .time-btn-large { font-size: 1.25rem; padding: 1.25rem; }
        .time-btn-big { font-size: 1.5rem; padding: .8rem 1.2rem; }
        @media (max-width:640px) {
            .card { padding: 1.2rem; border-radius: 18px; }
            .cat-pill { padding: .9rem 1rem; font-size: .95rem; }
        }
    </style>
</head>

<body class="p-6 md:p-12">

<div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-12">

    <div class="w-full lg:w-1/2 space-y-8">

        <header class="flex items-start gap-4">
            <h1 class="text-4xl font-black text-blue-900 mb-2">Hvor skal jeg reise?</h1>
            <div class="ml-auto hidden md:block">
                <button onclick="visOm()" class="px-4 py-2 bg-blue-600 text-white rounded-2xl font-bold">Om</button>
            </div>
        </header>

        <!-- Felt 1: Startpunkt -->
        <div class="card">
            <div class="flex items-center gap-4 mb-6">
                <span class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center font-bold">1</span>
                <h2 class="text-2xl font-black">Startpunkt</h2>
            </div>
            <div class="flex flex-wrap gap-3">
                <button onclick="brukMinPosisjon()" title="Bruk min posisjon"
                    class="px-4 bg-blue-600 text-white rounded-2xl font-bold flex items-center justify-center text-xl">
                    üìç
                </button>
                <input id="adresseSok" type="text" placeholder="S√∏k adresse..."
                    class="flex-1 min-w-[180px] p-4 bg-slate-50 rounded-2xl border border-slate-100 outline-none" />
                <button onclick="sokAdresse()"
                    class="px-6 sm:px-8 bg-[#1e293b] text-white rounded-2xl font-bold flex-1 sm:flex-none">
                    S√∏k
                </button>
            </div>
            <div id="map"></div>
        </div>

        <!-- Felt 2: Aktivitet -->
        <div class="card">
            <div class="flex items-center gap-4 mb-6">
                <span class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold">2</span>
                <h2 class="text-2xl font-black">Hva vil du gj√∏re?</h2>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:flex gap-2 p-2 bg-slate-100 rounded-[25px] mb-6">
                <button onclick="setKategori('sn√∏')" id="cat-sn√∏" class="cat-pill w-full">‚ùÑÔ∏è Sn√∏</button>
                <button onclick="setKategori('tur')" id="cat-tur" class="cat-pill w-full">ü•æ Tur</button>
                <button onclick="setKategori('sykkel')" id="cat-sykkel" class="cat-pill w-full">üö≤ Sykkel</button>
                <button onclick="setKategori('vind')" id="cat-vind" class="cat-pill w-full">üí® Vind</button>
                <button onclick="setKategori('sol')" id="cat-sol" class="cat-pill w-full sm:col-span-3 lg:col-span-1">‚òÄÔ∏è Sol</button>
            </div>
            <div id="sub-menu" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
        </div>

        <!-- Felt 3: Tid -->
        <div class="card flex-shrink-0" id="felt-3-tid" aria-label="Felt 3 - Tid">

            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                    <span class="w-9 h-9 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center font-bold">
                        3
                    </span>
                    <h2 class="text-xl font-black">N√•r?</h2>
                </div>

                <button onclick="settHurtigTid(0)" class="time-btn time-btn-blue px-4 py-2 text-base font-bold">
                    N√Ö
                </button>
            </div>

            <div class="space-y-2">

                <div class="grid grid-cols-2 gap-2">

                    <div class="flex items-center justify-between bg-blue-50 rounded-xl px-3 py-2">
                        <button onclick="justerTid(-60)" class="time-btn time-btn-blue px-3 py-1 text-base font-bold">‚àí</button>

                        <span class="text-sm font-bold text-blue-700 whitespace-nowrap">
                            1 time
                        </span>

                        <button onclick="justerTid(60)" class="time-btn time-btn-blue px-3 py-1 text-base font-bold">+</button>
                    </div>

                    <div class="flex items-center justify-between bg-blue-50 rounded-xl px-3 py-2">
                        <button onclick="justerTid(-360)"
                            class="time-btn time-btn-blue px-3 py-1 text-base font-bold">‚àí</button>

                        <span class="text-sm font-bold text-blue-700 whitespace-nowrap">
                            6 timer
                        </span>

                        <button onclick="justerTid(360)" class="time-btn time-btn-blue px-3 py-1 text-base font-bold">+</button>
                    </div>
                </div>

                <div class="flex items-center gap-3 bg-blue-50 rounded-2xl px-3 py-2">
                    <span class="text-[10px] font-black text-blue-400 uppercase tracking-widest">
                        VALGT TID:
                    </span>
                    <span id="visningsTid" class="text-sm font-bold text-blue-800"></span>
                </div>

            </div>
        </div>

    </div>

    <div class="w-full lg:w-1/2 space-y-8 lg:pl-4">
        <div id="results" class="space-y-4 pt-16"></div>
    </div>

</div>

<div class="fixed top-6 right-6 z-[2000] md:hidden">
    <button onclick="visOm()" class="px-4 py-2 bg-blue-600 text-white rounded-2xl font-bold">Om</button>
</div>

<div id="omModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[2000]">
    <div class="bg-white p-8 rounded-3xl max-w-lg w-full shadow-2xl overflow-y-auto max-h-[95vh]">
        <div class="flex justify-between items-start mb-6">
            <h2 class="text-2xl font-bold text-blue-900">Om programmet</h2>
            <button onclick="lukkOm()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
<!-- Bilder av dere -->
<div class="flex flex-wrap gap-4 justify-center">
    <img src="Bilder/Knut Espen.jpg" alt="Knut Espen √òvreberg"
         class="w-[40vw] max-w-[300px] min-w-[150px] h-auto border-2 border-blue-50 shadow-sm">
    <img src="Bilder/Steinar.jpg" alt="Steinar Bj√∏rnerud"
         class="w-[40vw] max-w-[300px] min-w-[150px] h-auto border-2 border-blue-50 shadow-sm">
</div>

        <div class="space-y-4 text-sm text-slate-700 leading-relaxed">
            <p>Form√•let med dette programmet er √• hjelpe deg til √• finne rett sted √• reise til for √• f√• en fin
                opplevelse.</p>
            <p>Utviklet av Knut Espen √òvreberg og Steinar Bj√∏rnerud.</p>
            <p class="text-[10px] text-slate-400 italic mt-4">&copy; 2026 Versjon 1.9.4</p>
        </div>
        <button onclick="lukkOm()" class="w-full mt-6 py-4 bg-blue-600 text-white font-bold rounded-2xl">Lukk</button>
    </div>
</div>

<script>
let startPos = { lat: 59.91, lon: 10.75 };
let hovedKategori = 'tur';
let underKategori = 'kyst';
let avreiseTid = new Date();
let alleSteder = [];
let marker;
let alleResultater = [];
let antallSynligeResultater = 5;

const subValg = {
    'sn√∏': [{ id: 'langrenn', navn: 'üéø Langrenn' }, { id: 'alpint', navn: 'üèÇ Alpint' }],
    'tur': [{ id: 'kyst', navn: 'üåä Kyst' }, { id: 'skog', navn: 'üå≤ Skog' }, { id: 'stier', navn: 'ü•æ Stier' }, { id: 'topper', navn: '‚õ∞Ô∏è Topper' }, { id: 'byen', navn: 'üèôÔ∏è By' }],
    'sykkel': [{ id: 'landevei', navn: 'üö¥ Landevei' }, { id: 'terreng', navn: 'üöµ Terreng' }],
    'vind': [{ id: 'hav', navn: 'üåä Hav' }, { id: 'innsj√∏', navn: 'üõ∂ Innsj√∏' }],
    'sol': [{ id: 'solsok', navn: '‚òÄÔ∏è Finn sola' }]
};

// --- kriterier og vekt for match ---
const kriterier = {
    sn√∏: {
        langrenn: { temperatur: { √∏nsketMin: -5, √∏nsketMax: 0, vekt: 3 }, sn√∏dybde: { √∏nsketMin: 10, vekt: 5 }, nedb√∏r: { √∏nsketMax: 2, vekt: 2 }, vind: { √∏nsketMax: 10, vekt: 2 } },
        alpint: { temperatur: { √∏nsketMin: -5, √∏nsketMax: 2, vekt: 3 }, sn√∏dybde: { √∏nsketMin: 20, vekt: 5 }, nedb√∏r: { √∏nsketMax: 3, vekt: 2 }, vind: { √∏nsketMax: 12, vekt: 2 } }
    },
    tur: {
        kyst: { vind: { √∏nsketMax: 8, vekt: 4 }, nedb√∏r: { √∏nsketMax: 2, vekt: 3 }, temperatur: { √∏nsketMin: 5, √∏nsketMax: 15, vekt: 3 } },
        skog: { vind: { √∏nsketMax: 10, vekt: 3 }, nedb√∏r: { √∏nsketMax: 3, vekt: 2 }, temperatur: { √∏nsketMin: 5, √∏nsketMax: 20, vekt: 3 } },
        stier: { vind: { √∏nsketMax: 8, vekt: 2 }, nedb√∏r: { √∏nsketMax: 2, vekt: 3 }, temperatur: { √∏nsketMin: 5, √∏nsketMax: 22, vekt: 3 } },
        topper: { vind: { √∏nsketMax: 6, vekt: 3 }, nedb√∏r: { √∏nsketMax: 2, vekt: 2 }, temperatur: { √∏nsketMin: -5, √∏nsketMax: 15, vekt: 3 } },
        byen: { vind: { √∏nsketMax: 12, vekt: 2 }, nedb√∏r: { √∏nsketMax: 3, vekt: 2 }, temperatur: { √∏nsketMin: 0, √∏nsketMax: 25, vekt: 2 } }
    },
    sykkel: {
        terreng: { vind: { √∏nsketMax: 10, vekt: 3 }, nedb√∏r: { √∏nsketMax: 2, vekt: 3 }, temperatur: { √∏nsketMin: 5, √∏nsketMax: 20, vekt: 4 } },
        landevei: { vind: { √∏nsketMax: 8, vekt: 4 }, nedb√∏r: { √∏nsketMax: 2, vekt: 3 }, temperatur: { √∏nsketMin: 5, √∏nsketMax: 22, vekt: 3 } }
    },
    sol: { nedb√∏r: { √∏nsketMax: 0, vekt: 3 }, skydekke: { √∏nsketMax: 20, vekt: 5 }, temperatur: { √∏nsketMin: 15, √∏nsketMax: 30, vekt: 4 } }
};

// ----- map -----
const map = L.map('map', { zoomControl: true }).setView([startPos.lat, startPos.lon], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
marker = L.marker([startPos.lat, startPos.lon], { draggable: true }).addTo(map);
marker.on('dragend', () => {
    startPos = { lat: marker.getLatLng().lat, lon: marker.getLatLng().lng };
    oppdaterOversikt();
});

// ----- helpers -----
function visOm() { document.getElementById('omModal').classList.remove('hidden'); }
function lukkOm() { document.getElementById('omModal').classList.add('hidden'); }
function brukMinPosisjon() {
    if(navigator.geolocation){navigator.geolocation.getCurrentPosition(p=>{startPos={lat:p.coords.latitude,lon:p.coords.longitude};marker.setLatLng([startPos.lat,startPos.lon]);map.setView([startPos.lat,startPos.lon],12);oppdaterOversikt()},e=>alert('Feil ved henting av posisjon: '+e.message))}else alert("Geolokasjon st√∏ttes ikke i denne nettleseren.");}
function sokAdresse() {
    const q=document.getElementById('adresseSok').value.trim();if(!q)return;
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`)
        .then(r=>r.json())
        .then(d=>{if(d&&d[0]){startPos={lat:parseFloat(d[0].lat),lon:parseFloat(d[0].lon)};marker.setLatLng([startPos.lat,startPos.lon]);map.setView([startPos.lat,startPos.lon],12);oppdaterOversikt()}else alert('Fant ingen treff for denne adressen.')})
        .catch(()=>alert('Feil ved adresseoppslag'));
}

// ----- beregn match -----
function beregnMatch(stedData,kategori,under) {
    let crit=kategori==='sol'? kriterier.sol : kriterier[kategori][under];
    let total=0, score=0;
    for(let k in crit){total+=crit[k].vekt;let val=stedData[k];if(val!==undefined){let min=crit[k].√∏nsketMin??-Infinity;let max=crit[k].√∏nsketMax??Infinity;if(val>=min&&val<=max){score+=crit[k].vekt}else{score+=crit[k].vekt* Math.max(0,1-Math.abs(val-(min+max)/2)/(Math.abs(max-min)||1))}}}
    return Math.round(100*score/total);
}

// ----- resultater -----
async function oppdaterOversikt() {
    const resDiv=document.getElementById('results');
    resDiv.innerHTML='<div class="p-10 text-center font-bold text-slate-300">Oppdaterer...</div>';

    let steder = alleSteder.filter(s => hovedKategori==='sol'? true : (s.hovedkategori===hovedKategori && s.underkategori===underKategori));
    let resultater = [];

    for(const sted of steder){
        try{
            const res=await fetch(`https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${sted.lat}&lon=${sted.lon}`);
            if(!res.ok) continue;
            const data=await res.json();
            if(!data.properties||!Array.isArray(data.properties.timeseries)||data.properties.timeseries.length===0) continue;
            const target=avreiseTid.getTime();
            const varsel=data.properties.timeseries.reduce((p,c)=>Math.abs(new Date(c.time)-target)<Math.abs(new Date(p.time)-target)?c:p);
            const t=varsel.data.instant.details.air_temperature;
            const v=varsel.data.instant.details.wind_speed;
            const eff=Math.round(13.12 + 0.6215*t - 11.37*Math.pow(v*3.6,0.16) + 0.3965*t*Math.pow(v*3.6,0.16));
            const sym=varsel.data.next_1_hours? varsel.data.next_1_hours.summary.symbol_code:'clearsky_day';
            const avstand=Math.sqrt(Math.pow(sted.lat-startPos.lat,2)+Math.pow(sted.lon-startPos.lon,2))*111;
            const match=beregnMatch({temperatur:t,vind:v},hovedKategori,underKategori);
            resultater.push({...sted,t,v,eff,sym,avstand,reiseTid:Math.round(avstand*1.6+10),match});
        }catch(e){console.warn('Feil for sted',sted,e);}
    }

    resultater.sort((a,b)=>b.match - a.match || a.avstand - b.avstand);
    alleResultater=resultater;
    antallSynligeResultater=5;
    renderResultater();
}

// ----- render 5-p√•-gangen -----
function renderResultater(){
    const resDiv=document.getElementById('results');
    if(alleResultater.length===0){resDiv.innerHTML='<div class="p-6 text-center text-slate-500">Ingen resultater √• vise.</div>';return;}
    let html=alleResultater.slice(0,antallSynligeResultater).map(s=>`
        <div class="card p-6 flex justify-between items-center group hover:border-blue-200 transition-all">
          <div class="flex-1 pr-4">
            <span class="text-[10px] font-black text-blue-500 uppercase tracking-widest">${s.fylke} ‚Ä¢ CA ${s.reiseTid} MIN</span>
            <h3 class="text-2xl font-black text-slate-800 my-1">${s.navn}</h3>
            <div class="flex gap-2 mt-3 flex-wrap">
              <span class="bg-slate-50 text-slate-600 px-3 py-1.5 rounded-xl text-[11px] font-bold border border-slate-100">üå°Ô∏è ${Math.round(s.t)}¬∞C</span>
              <span class="bg-blue-50 text-blue-700 px-3 py-1.5 rounded-xl text-[11px] font-bold border border-blue-100">Eff. temp: ${s.eff}¬∞C</span>
              <span class="bg-slate-50 text-slate-600 px-3 py-1.5 rounded-xl text-[11px] font-bold border border-slate-100">Vind: ${Math.round(s.v)} m/s</span>
              <span class="bg-green-50 text-green-700 px-3 py-1.5 rounded-xl text-[11px] font-bold border border-green-100">Match: ${s.match}%</span>
            </div>
          </div>
          <img src="https://raw.githubusercontent.com/metno/weathericons/main/weather/png/${s.sym}.png" class="w-16 h-16 opacity-90 group-hover:scale-110 transition-transform" alt="${s.sym}">
        </div>
    `).join('');
    if(antallSynligeResultater<alleResultater.length){
        html+=`<div class="text-center">
            <button onclick="visNeste()" class="px-6 py-3 bg-blue-600 text-white rounded-2xl font-bold">Vis de 5 neste</button>
        </div>`;
    }
    resDiv.innerHTML=html;
}

function visNeste(){antallSynligeResultater+=5;renderResultater();}

// ----- tid -----
function oppdaterTidVisning(){
    const maksTid=new Date(Date.now()+48*60*60*1000);
    if(avreiseTid>maksTid) avreiseTid=maksTid;
    if(avreiseTid<new Date()) avreiseTid=new Date();
    const dag=String(avreiseTid.getDate()).padStart(2,'0');
    const maned=String(avreiseTid.getMonth()+1).padStart(2,'0');
    const hour=String(avreiseTid.getHours()).padStart(2,'0');
    const min=String(avreiseTid.getMinutes()).padStart(2,'0');
    document.getElementById('visningsTid').innerText=`${dag}.${maned} ${hour}:${min}`;
}

// ----- kategorier -----
function setKategori(k){
    hovedKategori=k;
    underKategori=subValg[k][0].id;
    document.querySelectorAll('.cat-pill').forEach(b=>b.classList.toggle('active',b.id==='cat-'+k));
    oppdaterSubMeny();
    oppdaterOversikt();
    oppdaterTidVisning();
}

function oppdaterSubMeny(){
    const el=document.getElementById('sub-menu');
    el.innerHTML=subValg[hovedKategori].map(item=>`
        <button onclick="underKategori='${item.id}'; oppdaterSubMeny(); oppdaterOversikt();" class="sub-btn ${underKategori===item.id?'active':''}">
            ${item.navn}
        </button>
    `).join('');
}

// ----- tid hurtigvalg -----
function settHurtigTid(m){avreiseTid=m===0?new Date():new Date(Date.now()+m*60000);oppdaterTidVisning();oppdaterOversikt();}
function justerTid(m){avreiseTid=new Date(avreiseTid.getTime()+m*60000);oppdaterTidVisning();oppdaterOversikt();}

// ----- init -----
fetch('locations.json').then(r=>r.json()).then(data=>{alleSteder=data;oppdaterTidVisning();setKategori('tur');}).catch(err=>{console.warn('Kunne ikke hente locations.json',err);oppdaterTidVisning();});

window.oppdaterOversikt=oppdaterOversikt;
window.oppdaterTidVisning=oppdaterTidVisning;
</script>

</body>
</html>
